<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="copyright" content="Karl N. Redman 2004">
<meta name="keywords" content="run-free,GUI,command line launcher,application,xfree86,bash_history">
<meta name="description" content="run-free is a GUI command line lauching application for Xwindows">
<TITLE>run-free: GUI Command Line Launcher</TITLE>
<LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
</head>
<BODY BGCOLOR="#FFFFFF">
<font size="-3">
<center>
<table>
<tr>
	<td><a href="http://run-free.sourceforge.net" target="top">Project Homepage</a></td>
	<td><a href="http://sourceforge.net/projects/run-free/" target="top">Sourceforge Page</a></td>
	<td><a href="http://cvs.sourceforge.net/viewcvs.py/run-free/" target="top">CVS Repository</a></td>
	<td><a href="http://freshmeat.net/projects/run-free/" target="top">Freshmeat.net Page</a></td>
	<td><a href="https://sourceforge.net/project/showfiles.php?group_id=39135&package_id=112782" target="top">Download project</a></td>
	<td><a href="http://www.sleepingstill.com" target="top">Author's Homepage</a></td>
</tr>
</table>
</center>
</font>
<hr>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>main.c</h1><a href="main_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file main.c</span>
00002 <span class="comment">  \brief run-free main file</span>
00003 <span class="comment"></span>
00004 <span class="comment">  run-free is a command line launching program written in gtk. This</span>
00005 <span class="comment">  version of run-free is written is C for gtk+1.2</span>
00006 <span class="comment">*/</span>
00007 <span class="comment"></span>
00008 <span class="comment">/*! \mainpage </span>
00009 <span class="comment"> * \htmlinclude mainpage.html</span>
00010 <span class="comment"> * </span>
00011 <span class="comment"> * \htmlinclude maingraph.html</span>
00012 <span class="comment"> * </span>
00013 <span class="comment"> * &lt;b&gt;Here is the README file for this project:&lt;/b&gt;</span>
00014 <span class="comment"> * \verbinclude README</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * &lt;b&gt;Please note the License for this project:&lt;/b&gt;</span>
00017 <span class="comment"> * \verbinclude COPYING</span>
00018 <span class="comment"> */</span>
00019 
00020 <span class="comment">/* NOTICE:</span>
00021 <span class="comment">    Copyright (C) 2004  Karl N. Redman (SleepingStill.com)</span>
00022 <span class="comment"></span>
00023 <span class="comment">    This program is free software; you can redistribute it and/or modify</span>
00024 <span class="comment">    it under the terms of the GNU General Public License as published by</span>
00025 <span class="comment">    the Free Software Foundation; either version 2 of the License, or</span>
00026 <span class="comment">    (at your option) any later version.</span>
00027 <span class="comment"></span>
00028 <span class="comment">    This program is distributed in the hope that it will be useful,</span>
00029 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00030 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00031 <span class="comment">    GNU General Public License for more details.</span>
00032 <span class="comment"></span>
00033 <span class="comment">    You should have received a copy of the GNU General Public License</span>
00034 <span class="comment">    along with this program; if not, write to the Free Software</span>
00035 <span class="comment">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00036 <span class="comment"></span>
00037 <span class="comment">    For further information contact: parasyte@sleepingstill.com</span>
00038 <span class="comment">*/</span>
00039 
00040 
00041 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;config.h&gt;</span>
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045 
00046 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00047 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00048 <span class="preprocessor">#include &lt;string.h&gt;</span>
00049 <span class="preprocessor">#include &lt;gtk/gtk.h&gt;</span>
00050 
00051 <span class="preprocessor">#include "<a class="code" href="interface_8h.html">interface.h</a>"</span>
00052 <span class="preprocessor">#include "<a class="code" href="support_8h.html">support.h</a>"</span>
00053 <span class="preprocessor">#include "<a class="code" href="main_8h.html">main.h</a>"</span>
00054 <span class="preprocessor">#include "<a class="code" href="comboBox_8h.html">comboBox.h</a>"</span>
00055 <span class="preprocessor">#include "<a class="code" href="kbhit_8h.html">kbhit.h</a>"</span>
00056 <span class="preprocessor">#include "<a class="code" href="commonDefs_8h.html">commonDefs.h</a>"</span>
00057 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00058 <span class="preprocessor">#include "<a class="code" href="comboHandlers_8h.html">comboHandlers.h</a>"</span>
00059 <span class="preprocessor">#include "<a class="code" href="help_8h.html">help.h</a>"</span>
00060 
00061 <span class="preprocessor">#include &lt;getopt.h&gt;</span><span class="comment"></span>
00062 <span class="comment">/** @name getopt externs</span>
00063 <span class="comment"> *  externs from getopt functionality</span>
00064 <span class="comment"> */</span><span class="comment"></span>
00065 <span class="comment">//@{ </span>
00066 <span class="comment"></span><span class="comment">///command line options</span>
<a name="l00067"></a><a class="code" href="main_8c.html#a0">00067</a> <span class="comment"></span><span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="main_8c.html#a0">optarg</a>;                    <span class="comment"></span>
00068 <span class="comment">///option arguments</span>
<a name="l00069"></a><a class="code" href="main_8c.html#a3">00069</a> <span class="comment"></span><span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="main_8c.html#a1">optind</a>, <a class="code" href="main_8c.html#a2">opterr</a>, <a class="code" href="main_8c.html#a3">optopt</a>;<span class="comment"></span>
00070 <span class="comment">///the environment</span>
<a name="l00071"></a><a class="code" href="main_8c.html#a4">00071</a> <span class="comment"></span><span class="keyword">extern</span> <span class="keywordtype">char</span> **<a class="code" href="main_8c.html#a4">environ</a>;                  <span class="comment"></span>
00072 <span class="comment">//@}</span>
00073 <span class="comment"></span><span class="comment"></span>
00074 <span class="comment">/// The Main</span>
00075 <span class="comment"></span><span class="comment">/** Long mian function that is intended to be split up some day</span>
00076 <span class="comment"> */</span>
00077 <span class="keywordtype">int</span>
<a name="l00078"></a><a class="code" href="main_8c.html#a5">00078</a> <a class="code" href="main_8c.html#a5">main</a> (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">char</span> *env[])
00079 {
00080   gboolean gui =TRUE, history_set =FALSE, listops = FALSE;
00081   
00082 
00083   <span class="keywordtype">int</span> opt =0;
00084 
00085 
00086   <span class="comment">/*Global_Initialization -Items initialized for runtime</span>
00087 <span class="comment">   */</span>
00088   <a class="code" href="main_8h.html#a5">history_file</a> = NULL;          
00089   <a class="code" href="main_8h.html#a8">command</a> = NULL;
00090   <a class="code" href="main_8h.html#a7">terminal_path</a> = NULL;
00091   <a class="code" href="main_8h.html#a1">die</a> = TRUE;                   
00092   <a class="code" href="main_8h.html#a0">run_in_term</a> = FALSE;          
00093   <a class="code" href="main_8h.html#a2">no_kbhit</a> = FALSE;
00094   <a class="code" href="comboBox_8h.html#a4">combo_mode</a> = <a class="code" href="comboBox_8h.html#a1">RF_HISTORY_MODE</a>; 
00095   <a class="code" href="main_8h.html#a3">keep_open</a> = FALSE;
00096 
00097   <span class="comment">//init gtk stuff</span>
00098   gtk_set_locale ();
00099   gtk_init (&amp;argc, &amp;argv);
00100 
00101   <span class="keywordtype">char</span> *<a class="code" href="main_8h.html#a4">home_directory</a> = getenv(<span class="stringliteral">"HOME"</span>); <span class="comment">/*! get the user's home directory */</span>
00102 
00103   <span class="comment">//show debug mode message</span>
00104   <a class="code" href="debug_8h.html#a3">dprint</a>(<span class="stringliteral">"run-free: debug mode enabled"</span>);
00105 
00106   <span class="comment">//loop through the argument options</span>
00107   <span class="keywordflow">while</span>(1)
00108     {
00109       <span class="keywordtype">int</span> option_index = 0;
00110       <span class="keyword">static</span> <span class="keyword">struct </span>option long_options[] = {
00111         {<span class="stringliteral">"bash"</span>, 0, 0, <span class="charliteral">'b'</span>},
00112         {<span class="stringliteral">"command"</span>, 1, 0, <span class="charliteral">'c'</span>},
00113         {<span class="stringliteral">"die"</span>, 0, 0, <span class="charliteral">'d'</span>},
00114         {<span class="stringliteral">"help"</span>, 0, 0, <span class="charliteral">'h'</span>},
00115         {<span class="stringliteral">"histlen"</span>, 1, 0, 0},
00116         {<span class="stringliteral">"history"</span>, 1, 0, 0},
00117         {<span class="stringliteral">"kbhit"</span>, 0, 0, <span class="charliteral">'k'</span>},
00118         {<span class="stringliteral">"nokbhit"</span>, 0, 0, <span class="charliteral">'i'</span>},
00119         {<span class="stringliteral">"keystrokes"</span>, 0, 0, <span class="charliteral">'y'</span>},
00120         {<span class="stringliteral">"listops"</span>, 0, 0, <span class="charliteral">'l'</span>},
00121         {<span class="stringliteral">"termstay"</span>, 0, 0, <span class="charliteral">'o'</span>},
00122         {<span class="stringliteral">"runterm"</span>, 0, 0, <span class="charliteral">'r'</span>},
00123         {<span class="stringliteral">"terminal"</span>, 1, 0, <span class="charliteral">'t'</span>},
00124         {<span class="stringliteral">"version"</span>, 0, 0, <span class="charliteral">'V'</span>},
00125         <span class="comment">//{"smart", 0, 0, 's'},</span>
00126         {0, 0, 0, 0}
00127       };
00128 <span class="comment"></span>
00129 <span class="comment">      /**\todo cleanup getopt stuff -it's messy! */</span>
00130 
00131       <span class="comment">//do command line processing</span>
00132       opt = getopt_long(argc, argv, <span class="stringliteral">"bc:dhiklort:yV"</span>, long_options, &amp;option_index);
00133 
00134       <span class="keywordflow">if</span>(opt == -1)
00135         <span class="keywordflow">break</span>;
00136       
00137       <span class="keywordflow">switch</span>(opt)
00138         {
00139         <span class="keywordflow">case</span> 0:         <span class="comment">//long arguments</span>
00140           <span class="keywordflow">if</span>(strcmp(long_options[option_index].name, <a class="code" href="commonDefs_8h.html#a3">OPTARG_HISTORY</a>) ==0)
00141             {
00142               <span class="comment">//handle history file</span>
00143               <span class="keywordflow">if</span>(strcmp(<a class="code" href="main_8c.html#a0">optarg</a>, <a class="code" href="commonDefs_8h.html#a4">OPTARG_HISTORY_FILETYPE_RF</a>)==0) <span class="comment">//run-free</span>
00144                 {
00145                   <a class="code" href="main_8h.html#a5">history_file</a> = g_malloc(strlen(<a class="code" href="main_8h.html#a4">home_directory</a>)+strlen(<a class="code" href="commonDefs_8h.html#a0">RF_HISTORY_FILENAME</a>)+2);
00146                   sprintf(<a class="code" href="main_8h.html#a5">history_file</a>, <span class="stringliteral">"%s/%s"</span>, <a class="code" href="main_8h.html#a4">home_directory</a>, <a class="code" href="commonDefs_8h.html#a0">RF_HISTORY_FILENAME</a>);
00147                 }
00148               <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(<a class="code" href="main_8c.html#a0">optarg</a>, <a class="code" href="commonDefs_8h.html#a5">OPTARG_HISTORY_FILETYPE_BASH</a>)==0) <span class="comment">//bash</span>
00149                 {
00150                   <a class="code" href="main_8h.html#a5">history_file</a> = g_malloc(strlen(<a class="code" href="main_8h.html#a4">home_directory</a>)+strlen(BASH_HISTORY_FILENAME)+2);
00151                   sprintf(<a class="code" href="main_8h.html#a5">history_file</a>, <span class="stringliteral">"%s/%s"</span>, <a class="code" href="main_8h.html#a4">home_directory</a>, BASH_HISTORY_FILENAME);
00152                 }
00153               <span class="keywordflow">else</span>
00154                 {
00155                   <a class="code" href="main_8h.html#a5">history_file</a> = g_malloc(strlen(<a class="code" href="main_8c.html#a0">optarg</a>)+1);
00156                   sprintf(<a class="code" href="main_8h.html#a5">history_file</a>,<span class="stringliteral">"%s"</span>, <a class="code" href="main_8c.html#a0">optarg</a>); <span class="comment">//xxx</span>
00157                 }
00158               history_set++;
00159             }
00160           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(long_options[option_index].name, <a class="code" href="commonDefs_8h.html#a6">OPTARG_HISTORY_LEN</a>) ==0)
00161             {
00162               <a class="code" href="main_8h.html#a6">history_len</a> = atol(<a class="code" href="main_8c.html#a0">optarg</a>);
00163             }
00164           <span class="keywordflow">break</span>;
00165         <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:
00166           <a class="code" href="main_8h.html#a9">bash_shell_mode</a> = TRUE;
00167           <span class="keywordflow">break</span>;
00168         <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00169           <span class="comment">//copy command from command line</span>
00170           <span class="keywordflow">if</span>(<a class="code" href="main_8c.html#a0">optarg</a>)
00171             {
00172               <a class="code" href="main_8h.html#a8">command</a> = g_malloc(strlen(<a class="code" href="main_8c.html#a0">optarg</a>)+1);
00173               sprintf(<a class="code" href="main_8h.html#a8">command</a>, <span class="stringliteral">"%s"</span>, <a class="code" href="main_8c.html#a0">optarg</a>);           <span class="comment">/* copy the string */</span>
00174             }
00175           <span class="keywordflow">break</span>;
00176         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00177           <a class="code" href="main_8h.html#a1">die</a> = FALSE;
00178           <span class="keywordflow">break</span>;
00179         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00180           g_print(<span class="stringliteral">"%s: version %s.\n%s\n"</span>, PACKAGE, VERSION, COPYRIGHT);
00181           g_print(<span class="stringliteral">"%s\n\n"</span>, LICENSE);
00182           g_print(<span class="stringliteral">"\nHELP:\n"</span>);
00183           <span class="keywordtype">char</span> *help = 
00184             <span class="stringliteral">"-b, --bash\t\tRun in Bash mode (reads ~/.bashrc before execution)"</span>
00185             <span class="stringliteral">"\n"</span>
00186             <span class="stringliteral">"-c, --command=COMMAND\tSet COMMAND in entry box on startup"</span>
00187             <span class="stringliteral">"\n"</span>
00188             <span class="stringliteral">"-d, --die\t\tDo NOT die after executing a command"</span>
00189             <span class="stringliteral">"\n"</span>
00190             <span class="stringliteral">"-h, --help\t\tThis help list"</span>
00191             <span class="stringliteral">"\n"</span>
00192             <span class="stringliteral">"    --histlen=NUM\tShow NUM items from history in history list"</span>
00193             <span class="stringliteral">"\n"</span>
00194             <span class="stringliteral">"    --history=FILEPATH\tUse history file from FILEPATH"</span>
00195             <span class="stringliteral">"\n"</span>
00196             <span class="stringliteral">"-i, --nokbhit\t\tDo NOT allow keyboard hit mode (DON'T show \"HIT ANY KEY\" on exit)"</span>
00197             <span class="stringliteral">"\n"</span>
00198             <span class="stringliteral">"-k, --kbhit\t\tRun in keyboard hit mode (show \"HIT ANY KEY\" and exit)"</span>
00199             <span class="stringliteral">"\n"</span>
00200             <span class="stringliteral">"-l, --listops\t\tList default (compiled in) options and exit"</span>
00201             <span class="stringliteral">"\n"</span>
00202             <span class="stringliteral">"-o, --termstay\t\tKeep the terminal open after command exec"</span>
00203             <span class="stringliteral">"\n"</span>
00204             <span class="stringliteral">"-r, --runterm\t\tSet run_in_term mode on startup"</span>
00205             <span class="stringliteral">"\n"</span>
00206             <span class="stringliteral">"-t, --terminal=TERMPATH\tUse TERMPATH program for run_in_terminal mode"</span>
00207             <span class="stringliteral">"\n"</span>
00208             <span class="stringliteral">"-y, --keystrokes\tDisplay the keystrokes for run-free"</span>
00209             <span class="stringliteral">"\n"</span>
00210             <span class="stringliteral">"-V, --version\t\tShow version and copyright information"</span>
00211             <span class="stringliteral">"\n"</span>;
00212           g_print(<span class="stringliteral">"%s"</span>, help);
00213           exit(0);
00214           <span class="keywordflow">break</span>;
00215         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00216           <a class="code" href="main_8h.html#a2">no_kbhit</a> = TRUE;
00217           <span class="keywordflow">break</span>;
00218         <span class="keywordflow">case</span> <span class="charliteral">'k'</span>:
00219           gui = FALSE;
00220           <span class="keywordflow">break</span>;
00221         <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
00222           listops = TRUE;
00223           <span class="keywordflow">break</span>;
00224         <span class="keywordflow">case</span> <span class="charliteral">'o'</span>:
00225           <a class="code" href="main_8h.html#a3">keep_open</a> = TRUE;
00226           <span class="keywordflow">break</span>;
00227         <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
00228           <a class="code" href="main_8h.html#a0">run_in_term</a> = TRUE;
00229           <span class="keywordflow">break</span>;
00230         <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00231           <span class="keywordflow">if</span>(<a class="code" href="main_8c.html#a0">optarg</a>)
00232             {
00233               <a class="code" href="main_8h.html#a7">terminal_path</a> = g_malloc(strlen(<a class="code" href="main_8c.html#a0">optarg</a>)+1);
00234               sprintf(<a class="code" href="main_8h.html#a7">terminal_path</a>, <span class="stringliteral">"%s"</span>, <a class="code" href="main_8c.html#a0">optarg</a>);
00235             }
00236           <span class="keywordflow">break</span>;
00237         <span class="keywordflow">case</span> <span class="charliteral">'y'</span>:
00238           g_print(<span class="stringliteral">"%s: version %s.\n%s\n"</span>, PACKAGE, VERSION, COPYRIGHT);
00239           g_print(<span class="stringliteral">"%s\n\n"</span>, LICENSE);
00240           g_print(<span class="stringliteral">"\nKEYSTROKES:\n"</span>);
00241           g_print(<span class="stringliteral">"%s\n"</span>,<a class="code" href="help_8h.html#a0">KEYSTROKES</a>);
00242 <span class="comment"></span>
00243 <span class="comment">          /**\todo add cleanup routines */</span>
00244 
00245           <span class="comment">//cleanup</span>
00246           <a class="code" href="comboHandlers_8h.html#a1">freeList</a>(<a class="code" href="comboBox_8h.html#a3">cbitems</a>);
00247           g_free(<a class="code" href="main_8h.html#a5">history_file</a>);
00248           g_free(<a class="code" href="main_8h.html#a4">home_directory</a>);
00249           g_free(<a class="code" href="main_8h.html#a8">command</a>);
00250           g_free(<a class="code" href="main_8h.html#a7">terminal_path</a>);
00251           exit(0);
00252           <span class="keywordflow">break</span>;
00253         <span class="keywordflow">case</span> <span class="charliteral">'V'</span>:
00254           g_print(<span class="stringliteral">"%s: version %s.\n%s\n"</span>, PACKAGE, VERSION, COPYRIGHT);
00255           g_print(<span class="stringliteral">"%s\n\n"</span>, LICENSE);
00256           exit(0);
00257           <span class="keywordflow">break</span>;
00258         <span class="keywordflow">default</span>:
00259           <a class="code" href="debug_8h.html#a3">dprint</a>(<span class="stringliteral">"an argument is not being delt with"</span>);
00260           <span class="keywordflow">break</span>;
00261         }
00262     }
00263   
00264 
00265   <span class="comment">//handle options not set</span>
00266   <span class="keywordflow">if</span>(!history_set)
00267     {
00268       <span class="comment">//string terminators are accounted for</span>
00269 <span class="preprocessor">#ifdef USE_USER_HISTORY_FILENAME </span>
00270 <span class="preprocessor"></span>      <a class="code" href="debug_8h.html#a5">dprint_s2</a>(<span class="stringliteral">"user history compile option"</span>,USER_HISTORY_FILENAME);
00271       <a class="code" href="main_8h.html#a5">history_file</a> = g_malloc(strlen(USER_HISTORY_FILENAME)+1);
00272       sprintf(<a class="code" href="main_8h.html#a5">history_file</a>, <span class="stringliteral">"%s"</span>, USER_HISTORY_FILENAME);
00273 <span class="preprocessor">#else </span>
00274 <span class="preprocessor"></span>      <a class="code" href="debug_8h.html#a5">dprint_s2</a>(<span class="stringliteral">"bash history compile option"</span>,BASH_HISTORY_FILENAME);
00275       <a class="code" href="main_8h.html#a5">history_file</a> = g_malloc(strlen(<a class="code" href="main_8h.html#a4">home_directory</a>)+strlen(BASH_HISTORY_FILENAME)+2);
00276       sprintf(<a class="code" href="main_8h.html#a5">history_file</a>, <span class="stringliteral">"%s/%s"</span>, <a class="code" href="main_8h.html#a4">home_directory</a>, BASH_HISTORY_FILENAME);
00277 <span class="preprocessor">#endif</span>
00278 <span class="preprocessor"></span>    }
00279 
00280   <span class="keywordflow">if</span>(!<a class="code" href="main_8h.html#a6">history_len</a>)
00281     <a class="code" href="main_8h.html#a6">history_len</a> = DEFAULT_HISTORY_LEN;
00282 
00283   <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a7">terminal_path</a> == NULL)
00284     {
00285       <a class="code" href="main_8h.html#a7">terminal_path</a> = g_malloc(strlen(DEFAULT_TERMINAL_PATH)+1);
00286       sprintf(<a class="code" href="main_8h.html#a7">terminal_path</a>, <span class="stringliteral">"%s"</span>, DEFAULT_TERMINAL_PATH);
00287     }
00288 
00289   <span class="keywordflow">if</span>(listops)
00290     {
00291       g_print(<span class="stringliteral">"%s: version %s.\n%s\n"</span>, PACKAGE, VERSION, COPYRIGHT);
00292       g_print(<span class="stringliteral">"%s\n\n"</span>, LICENSE);
00293       g_print(<span class="stringliteral">"\n"</span>);
00294 
00295 <span class="preprocessor">#ifdef USE_USER_HISTORY_FILENAME</span>
00296 <span class="preprocessor"></span>      <span class="keywordtype">char</span> *use_user_history_filename = <span class="stringliteral">"yes"</span>;
00297 <span class="preprocessor">#else</span>
00298 <span class="preprocessor"></span>      <span class="keywordtype">char</span> *use_user_history_filename = <span class="stringliteral">"no"</span>;
00299 <span class="preprocessor">#endif</span>
00300 <span class="preprocessor"></span>      <span class="comment">//list the default run-time options and exit</span>
00301       g_print(<span class="stringliteral">"debug mode \t\t\t\t=%s\n"</span>, <a class="code" href="debug_8h.html#a0">DEBUG_MODE</a>?<span class="stringliteral">"yes"</span>:<span class="stringliteral">"no"</span>);
00302       g_print(<span class="stringliteral">"default history display length\t\t=%d\n"</span>, <a class="code" href="main_8h.html#a6">history_len</a>);
00303       g_print(<span class="stringliteral">"use user history file by default\t=%s\n"</span>,use_user_history_filename);
00304       g_print(<span class="stringliteral">"name of default user history file: %s\n"</span>, USER_HISTORY_FILENAME);
00305       g_print(<span class="stringliteral">"name of default bash history file:%s/%s\n"</span>, <a class="code" href="main_8h.html#a4">home_directory</a>, BASH_HISTORY_FILENAME);
00306       g_print(<span class="stringliteral">"run_in_term mode terminal path:%s\n"</span>, <a class="code" href="main_8h.html#a7">terminal_path</a>);
00307       exit(0);
00308     }
00309 
00310 
00311   <span class="comment">//post handle command line options </span>
00312   <span class="keywordflow">if</span>(!gui)
00313     {
00314         <a class="code" href="kbhit_8c.html#a1">do_kbhit</a>();
00315       
00316       <span class="comment">//cleanup</span>
00317       <a class="code" href="comboHandlers_8h.html#a1">freeList</a>(<a class="code" href="comboBox_8h.html#a3">cbitems</a>);
00318       g_free(<a class="code" href="main_8h.html#a5">history_file</a>);
00319       g_free(<a class="code" href="main_8h.html#a4">home_directory</a>);
00320       g_free(<a class="code" href="main_8h.html#a8">command</a>);
00321       g_free(<a class="code" href="main_8h.html#a7">terminal_path</a>);
00322     }
00323   <span class="keywordflow">else</span>
00324     {
00325       <span class="comment">//already did this</span>
00326       <span class="comment">//gtk_set_locale ();</span>
00327       <span class="comment">//gtk_init (&amp;argc, &amp;argv);</span>
00328     
00329       <span class="comment">//create the main window</span>
00330       <a class="code" href="interface_8h.html#a0">mainWindow</a> = <a class="code" href="interface_8c.html#a0">create_mainWindow</a> ();
00331       gtk_widget_show (<a class="code" href="interface_8h.html#a0">mainWindow</a>);
00332 
00333       <span class="comment">//we create it but don't show it until it's needed</span>
00334       <a class="code" href="interface_8h.html#a1">fileselection</a> = <a class="code" href="interface_8c.html#a1">create_fileselection</a> ();
00335 
00336       <span class="comment">//set the state of the run_in_term button</span>
00337       <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a0">run_in_term</a>)
00338         {
00339           <a class="code" href="main_8h.html#a0">run_in_term</a> = FALSE;  <span class="comment">/* cheezy */</span>
00340           gtk_button_clicked(GTK_BUTTON(<a class="code" href="interface_8h.html#a2">checkbutton</a>)); 
00341         }
00342 
00343       <span class="comment">//initialize the combo box in history mode</span>
00344       <span class="comment">//combo_init(RF_HISTORY_MODE);</span>
00345       <a class="code" href="comboBox_8h.html#a5">combo_init</a>(<a class="code" href="comboBox_8h.html#a0">RF_EXAMPLE_MODE</a>);
00346       <a class="code" href="comboBox_8h.html#a5">combo_init</a>(<a class="code" href="comboBox_8h.html#a1">RF_HISTORY_MODE</a>);
00347 
00348       <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a8">command</a> !=NULL)
00349         {
00350           <span class="comment">//gtk_entry_set_text(combo_entry1, command);</span>
00351           gtk_entry_set_text(GTK_ENTRY(GTK_COMBO(<a class="code" href="interface_8h.html#a4">combo1</a>)-&gt;entry), <a class="code" href="main_8h.html#a8">command</a>);
00352           <a class="code" href="debug_8h.html#a5">dprint_s2</a>(<span class="stringliteral">"startup command"</span>, <a class="code" href="main_8h.html#a8">command</a>);
00353         }
00354       
00355       <span class="comment">//run the program</span>
00356       gtk_main ();
00357     }
00358 
00359   <span class="keywordflow">return</span> 0;
00360 }
00361 
00362 
00363 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00364 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00365 <span class="comment"></span>
00366 <span class="comment">/** </span>
00367 <span class="comment">    \brief Internal custom "system" call</span>
00368 <span class="comment"></span>
00369 <span class="comment">    \author Karl N. Redman</span>
00370 <span class="comment"></span>
00371 <span class="comment">    \param command The command we want to run</span>
00372 <span class="comment"></span>
00373 <span class="comment">    &lt;b&gt;</span>
00374 <span class="comment">    Purpose:&lt;/b&gt; </span>
00375 <span class="comment">    Execute the command in a way that is consistant with the</span>
00376 <span class="comment">    design of run-free.</span>
00377 <span class="comment">    </span>
00378 <span class="comment">    \note</span>
00379 <span class="comment">    This is a custom system() type call in order to handle</span>
00380 <span class="comment">    environment settings properly (in the future) if this program is</span>
00381 <span class="comment">    to be a setuid application (which is in the works) </span>
00382 <span class="comment">*/</span>
<a name="l00383"></a><a class="code" href="main_8h.html#a10">00383</a> <span class="keywordtype">void</span> <a class="code" href="main_8h.html#a10">run_command</a>(<span class="keywordtype">char</span> *command)
00384 {
00385 
00386   <span class="keywordtype">char</span> pre[64], post[64], *buffer;
00387 
00388   <span class="comment">//anything except NULL is allowed.</span>
00389   <span class="keywordflow">if</span>(!<a class="code" href="main_8h.html#a8">command</a>)
00390     <span class="keywordflow">return</span>;
00391 
00392   <span class="comment">//populate parts of the command</span>
00393   <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a0">run_in_term</a>)
00394     {
00395       <span class="comment">//we want to run this in a terminal so act accordingly</span>
00396       <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a9">bash_shell_mode</a> == TRUE)
00397         {
00398           <span class="comment">//endable user alias settings (i.e. ls --color)</span>
00399           strcpy(pre,<span class="stringliteral">" -e bash -i -c \'"</span>);
00400         }
00401       <span class="keywordflow">else</span>
00402         {
00403           strcpy(pre,<span class="stringliteral">" -e sh -c \'"</span>);
00404         }
00405 
00406       <span class="keywordflow">if</span>(!<a class="code" href="main_8h.html#a2">no_kbhit</a>)
00407         {
00408           <span class="comment">//alsways show "HIT ANY KEY"</span>
00409           <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a3">keep_open</a>)
00410             <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a9">bash_shell_mode</a> == TRUE)
00411               strcpy(post, <span class="stringliteral">";  bash -i \'&amp;"</span>);
00412             <span class="keywordflow">else</span>
00413               strcpy(post, <span class="stringliteral">";  sh \'&amp;"</span>);
00414           <span class="keywordflow">else</span>
00415             strcpy(post, <span class="stringliteral">"; run-free -k \'&amp;"</span>);
00416         }
00417       <span class="keywordflow">else</span>
00418         <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a3">keep_open</a>)
00419             <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a9">bash_shell_mode</a> == TRUE)
00420               strcpy(post, <span class="stringliteral">";  bash -i \'&amp;"</span>);
00421             <span class="keywordflow">else</span>
00422               strcpy(post, <span class="stringliteral">";  sh \'&amp;"</span>);
00423         <span class="keywordflow">else</span>
00424           strcpy(post, <span class="stringliteral">"; \'&amp;"</span>);
00425         
00426 
00427       <span class="comment">//allocate a buffer</span>
00428       buffer = g_malloc(strlen(<a class="code" href="main_8h.html#a7">terminal_path</a>)
00429                       +strlen(pre)
00430                       +strlen(<a class="code" href="main_8h.html#a8">command</a>)
00431                       +strlen(post)
00432                       +1);
00433       
00434       <span class="comment">//populate the buffer with the command</span>
00435       sprintf(buffer, <span class="stringliteral">"%s%s%s%s"</span>, <a class="code" href="main_8h.html#a7">terminal_path</a>, pre, <a class="code" href="main_8h.html#a8">command</a>, post);
00436     }
00437   <span class="keywordflow">else</span>
00438     {
00439       <span class="comment">//no terminal, we must want to just execute something in the</span>
00440       <span class="comment">//background</span>
00441       strcpy(pre, <span class="stringliteral">""</span>);
00442       strcpy(post, <span class="stringliteral">" &amp;"</span>);
00443 
00444       <span class="comment">//allocate a buffer</span>
00445       buffer = g_malloc( +strlen(pre)
00446                       +strlen(<a class="code" href="main_8h.html#a8">command</a>)
00447                       +strlen(post)
00448                       +1);
00449       
00450       <span class="comment">//populate the buffer with the command</span>
00451       sprintf(buffer, <span class="stringliteral">"%s%s%s"</span>, pre, <a class="code" href="main_8h.html#a8">command</a>, post);
00452     }
00453       
00454 
00455 
00456   <span class="comment">//fork the program to execute the command</span>
00457   <span class="keywordtype">int</span> pid = fork();
00458 
00459   <span class="comment">//if we are the child...</span>
00460   <span class="keywordflow">if</span>(pid == 0)
00461     {
00462       <span class="comment">//update the history file</span>
00463       <a class="code" href="comboHandlers_8h.html#a3">writeHistory</a>(<a class="code" href="main_8h.html#a8">command</a>, <a class="code" href="main_8h.html#a5">history_file</a>);
00464 
00465       <span class="comment">//populate the command to execute </span>
00466       <span class="keywordtype">char</span> * argv[4];
00467       argv[0] = <span class="stringliteral">"sh"</span>;
00468       argv[1] = <span class="stringliteral">"-c"</span>;
00469       argv[2] = (<span class="keywordtype">char</span> *)buffer;
00470       argv[3] = 0;
00471 <span class="comment"></span>
00472 <span class="comment">      /**\warning</span>
00473 <span class="comment">         NOTE: this function is a potential security problem because we are not</span>
00474 <span class="comment">         replacing the environment. if this is ever going to be a SUID</span>
00475 <span class="comment">         application then I need to handle this. I'll work on this in the</span>
00476 <span class="comment">         future -parasyte</span>
00477 <span class="comment">      */</span>
00478       <span class="comment">//execute the program</span>
00479       execve(<span class="stringliteral">"/bin/sh"</span>, argv, <a class="code" href="main_8c.html#a4">environ</a>);
00480       
00481       <span class="comment">//free memory</span>
00482       g_free(buffer);
00483 
00484       <span class="comment">//exit properly</span>
00485       exit(0);
00486     }
00487   <span class="keywordflow">else</span>
00488     {
00489       g_free(buffer);
00490 
00491       <span class="keywordflow">if</span>(<a class="code" href="main_8h.html#a1">die</a>)
00492         {
00493           <span class="comment">//kill the main program</span>
00494           gtk_main_quit();
00495         }
00496       <span class="keywordflow">else</span>
00497         {
00498           <span class="comment">//update the history list</span>
00499           <a class="code" href="comboBox_8h.html#a5">combo_init</a>(<a class="code" href="comboBox_8h.html#a4">combo_mode</a>);
00500         }
00501     }
00502 }
00503 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Mar 18 07:26:17 2004 for run-free by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
